<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WHATTHEFIT</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Barrio&display=swap" rel="stylesheet">

    <style>
      :root {
        --background-color:#1a1a1a; --text-color:#f0f0f0; --card-background:#2c2c2c;
        --feature-background:#333333; --input-background:#444; --border-color:#555;
        --primary-accent-color: #000;
        --primary-accent-hover: #333;
        --checkmark-color: #000;
      }
      [data-theme="light"]{
        --background-color:#f0f2f5; --text-color:#1c2121; --card-background:#fff;
        --feature-background:#fdfdfd; --input-background:#e4e6eb; --border-color:#ced0d4;
      }
      body{font-family:"Funnel Display",sans-serif;font-size:16px;background:var(--background-color);color:var(--text-color);
        margin:0;padding:20px;transition:.3s}
      .container{max-width:1200px;margin:auto;background:var(--card-background);padding:30px;border-radius:15px}
      h1{text-align:center;color:var(--primary-accent-color);font-family:"Barrio",system-ui;font-size:80px;transition:.3s}
      h2{text-align:center;color:var(--primary-accent-color);transition:.3s;}
      
      .feature-container { display: flex; gap: 20px; margin-bottom: 20px; }
      .control-panel { flex: 1; min-width: 320px; }
      .canvas { flex: 2; display: flex; flex-direction: column; min-width: 0; }
      .feature { background:var(--feature-background); padding:20px; border-radius:10px; box-sizing: border-box; display:flex; flex-direction:column; }
      .output-feature { flex-grow: 1; }
      .output { flex-grow: 1; overflow-y: auto; min-height: 0; }
      
      @media (min-width: 901px) {
        #tab-content-0 .feature-container { flex-direction: row-reverse; }
        #tab-content-0 .control-panel { flex: 1.5; }
        #tab-content-0 .canvas { flex: 1; }
      }

      .theme-switcher{display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:30px;
        background:var(--feature-background);padding:10px;border-radius:10px}
      .theme-button {
        padding:8px 12px; border:1px solid var(--border-color); background-color:var(--input-background); color:var(--text-color); 
        border-radius:8px; cursor:pointer; font-family:"Funnel Display",sans-serif;
        transition: all 0.3s ease;
      }
      .theme-button:hover {
        background: var(--primary-accent-hover); color: #fff;
        box-shadow: 0 0 15px var(--primary-accent-hover), 0 0 25px var(--primary-accent-hover);
      }
      
      .color-input-wrapper{display:flex;align-items:center;gap:10px}
      .color-picker-label{position:relative;display:inline-block;width:30px;height:30px;cursor:pointer;border-radius:50%;border:1px solid var(--border-color)}
      input[type="color"]{opacity:0;width:100%;height:100%;cursor:pointer;position:absolute;top:0;left:0}
      
      label{display:block;margin-bottom:8px;font-weight:bold}
      select,.checkbox-group{width:100%;padding:10px;margin-bottom:15px;border-radius:8px;font-size:1em;
        border:1px solid var(--border-color);background:var(--input-background);color:var(--text-color);box-sizing:border-box}
      .color-selection-wrapper{position: relative; margin-bottom: 8px;}
      .checkbox-container{background:var(--input-background);padding:10px;border-radius:8px;margin-bottom:15px;
        border:1px solid var(--border-color)}
      .checkbox-group{display:flex;flex-wrap:wrap;gap:15px}
      .checkbox-group label{font-weight:normal;display:flex;align-items:center;gap:5px}
      
      .button-group{margin-bottom:20px; display:flex; flex-wrap:wrap; gap:8px;}
      .button-group button, .palette-generate-button {
        padding:8px 16px; border:none; border-radius:8px; cursor:pointer;
        background: var(--primary-accent-color);
        color:#fff; font-size:0.9em; font-family:"Funnel Display",sans-serif;
        font-weight:bold; margin-right:0; transition: all 0.3s ease;
      }
      .button-group button:hover:not(:disabled), .palette-generate-button:hover:not(:disabled){
        background: var(--primary-accent-hover);
        box-shadow: 0 0 15px var(--primary-accent-hover), 0 0 25px var(--primary-accent-hover);
      }
      .button-group button:disabled, .palette-generate-button:disabled{ background: #555 !important; cursor:not-allowed; opacity:.7; box-shadow: none;}
      
      .output, .about-us-content {
        padding:15px; background:var(--card-background); border-radius:8px; white-space:pre-wrap;
        border:1px solid var(--border-color); line-height:1.6; font-size:1em;
      }
      
      .tabs { 
        display: flex; justify-content: center; gap: 10px; 
        margin-bottom: 20px; border-bottom: 2px solid var(--border-color); 
      }
      .tab-button { background: none; border: none; padding: 10px 15px; font-size: 1.1em; cursor: pointer; color: var(--text-color); opacity: 0.6; position: relative; }
      .tab-button.active { opacity: 1; font-weight: bold; }
      .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--primary-accent-color); }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      
      #feature0-inputs { align-items: center; }
      .camera-container { position: relative; width: 100%; }
      #camera-feed, #capture-canvas {
        width: 100%; border-radius: 8px; background: #000; aspect-ratio: 4 / 3;
        object-fit: contain;
      }
      #camera-feed { transform: scaleX(-1); display: block; }
      #capture-canvas { display: none; }
      #countdown-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: none; justify-content: center; align-items: center;
        font-size: 8rem; font-weight: bold; color: rgba(255, 255, 255, 0.9);
        -webkit-text-stroke: 2px black; text-stroke: 2px black;
        z-index: 10;
      }
      
      #timer-controls {
        display: none; flex-direction: column; align-items: center; margin-top: 15px; gap: 10px;
      }
      .timer-options { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
      #timer-controls label {
        display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0; font-weight: normal;
      }
      #timer-controls input[type="radio"] {
        appearance: none; -webkit-appearance: none; margin: 0; width: 20px; height: 20px;
        border: 2px solid var(--border-color); border-radius: 50%; transition: all 0.2s; cursor: pointer;
      }
      #timer-controls input[type="radio"]::after {
        content: ''; display: block; width: 10px; height: 10px; border-radius: 50%; position: relative;
        top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
        background-color: var(--primary-accent-color); transition: transform 0.2s ease-in-out;
      }
      #timer-controls input[type="radio"]:checked { border-color: var(--primary-accent-color); }
      #timer-controls input[type="radio"]:checked::after { transform: translate(-50%, -50%) scale(1); }

      .palette-container{
        position: relative; margin-top:8px; padding:10px; background-color:var(--input-background); border-radius:8px; 
        min-height:50px; text-align:center;
      }
      .palette{position:relative; margin-top:8px; cursor:pointer; padding:5px; border-radius:5px; transition: background-color 0.2s; text-align:left;}
      .palette:hover{ background-color: var(--border-color); }
      .palette h4{margin:0 0 5px 0;font-size:0.9em;opacity:0.8;}
      .swatches{display:flex;gap:5px;}
      .swatch{width:25px;height:25px;border-radius:50%;border:1px solid var(--border-color);}
      .checkmark{
        display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%); 
        font-size:1.5em; color: var(--checkmark-color); transition: color 0.3s;
      }
      .palette.selected .checkmark{display:block;}

      @media (max-width: 600px) {
        body { padding: 10px; }
        .container { padding: 15px; }
        h1 { font-size: 50px; }
        h2 { font-size: 1.5em; }
        .feature { padding: 15px; }
        .feature-container { flex-direction: column; }
        .tabs { gap: 5px; font-size: 0.9em; overflow-x: auto; }
        .tab-button { padding: 8px 10px; }
        .theme-switcher { flex-direction: column; gap: 10px; }
        #countdown-overlay { font-size: 5rem; }
        .button-group { justify-content: center; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>WHATTHEFIT</h1>

      <div class="theme-switcher">
        <span>Theme:</span>
        <button id="light-mode-btn" class="theme-button">Light</button>
        <button id="dark-mode-btn" class="theme-button">Dark</button>
        <div class="color-input-wrapper">
          <span>Accent:</span>
          <label class="color-picker-label" id="accent-color-preview" style="background-color: #000000;">
            <input type="color" id="accent-color-picker" value="#000000">
          </label>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-button active" data-tab="about">About Us</button>
        <button class="tab-button" data-tab="0">Live Fit Check</button>
        <button class="tab-button" data-tab="1">Your Daily Outfits</button>
        <button class="tab-button" data-tab="2">Fashion Concept</button>
      </div>

      <div id="tab-content-about" class="tab-content active">
        <div class="about-us-content">
          <b>WHATTHEFIT</b> is an AI-powered style assistant built for fashion students, designers, and everyday creators who want to sharpen their eye and experiment fearlessly.<br><br>
          Turn on your camera, and WHATTHEFIT analyzes your current outfit, giving you personalized styling tips, color balance suggestions, and ways to remix your look while learning what works for your proportions and vibe.<br><br>
          If you prefer privacy, you can manually add the pieces you want to wear or design. The system then generates full outfit ideas, showing how different garments, fabrics, and colors can work together.<br><br>
          Beyond styling, WHATTHEFIT is designed to spark creativity, helping fashion students and designers discover new combinations, explore fresh aesthetics, and build confidence in their visual decisions. It’s not just about dressing better, it’s about thinking like a designer.
        </div>
      </div>

      <div id="tab-content-0" class="tab-content">
        <div class="feature-container">
          <div class="control-panel">
            <div id="feature0-inputs" class="feature">
              <h2>Live Fit Check</h2>
              <div class="camera-container">
                  <video id="camera-feed" playsinline></video>
                  <canvas id="capture-canvas"></canvas>
                  <div id="countdown-overlay"></div>
              </div>
              <div id="timer-controls">
                <strong>Timer:</strong>
                <div class="timer-options">
                    <label><input type="radio" name="timer" value="0" checked> Off</label>
                    <label><input type="radio" name="timer" value="3"> 3s</label>
                    <label><input type="radio" name="timer" value="5"> 5s</label>
                    <label><input type="radio" name="timer" value="10"> 10s</label>
                    <label><input type="radio" name="timer" value="15"> 15s</label>
                </div>
              </div>
              <div class="button-group" style="justify-content: center; margin-top: 15px;">
                <button id="start-camera" data-original-text="Start Camera">Start Camera</button>
                <button id="stop-camera" data-original-text="Stop Camera" style="display: none;">Stop Camera</button>
                <button id="upload-image" data-original-text="Upload Picture">Upload Picture</button>
                <input type="file" id="image-uploader" accept="image/*" style="display:none;" />
                <button id="capture-image" data-original-text="Analyze Outfit" disabled>Analyze Outfit</button>
              </div>
            </div>
          </div>
          <div class="canvas">
            <div id="feature0-output" class="feature output-feature">
              <div id="output0" class="output">Enable your camera or upload a picture to get styling ideas.</div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="tab-content-1" class="tab-content">
        <div class="feature-container">
          <div class="control-panel">
            <div id="feature1-inputs" class="feature">
              <h2>Your Daily Outfits</h2>
              <label for="style1">Style</label>
              <select id="style1">
                <option>Minimalist</option><option>Casual</option><option>Sporty</option><option>Gothic</option>
                <option>Classic</option><option>Punk</option><option>Futuristic</option><option>Y2K</option>
                <option>Formal</option><option>Vintage</option><option>Streetwear</option><option>Bohemia</option>
              </select>
              <label>Garment Type</label>
              <div class="checkbox-container">
                <div class="checkbox-group" id="garmentType1">
                  <label><input type="checkbox" value="Blazer">Blazer</label><label><input type="checkbox" value="Dress">Dress</label>
                  <label><input type="checkbox" value="Skirt">Skirt</label><label><input type="checkbox" value="Trousers">Trousers</label>
                  <label><input type="checkbox" value="Jumpsuit">Jumpsuit</label><label><input type="checkbox" value="Hoodie">Hoodie</label>
                  <label><input type="checkbox" value="Coat">Coat</label><label><input type="checkbox" value="Shirt">Shirt</label>
                  <label><input type="checkbox" value="T-Shirt">T-Shirt</label><label><input type="checkbox" value="Gown">Gown</label>
                  <label><input type="checkbox" value="Set">Set</label><label><input type="checkbox" value="Shoes">Shoes</label>
                </div>
              </div>
              <label for="bodyShape1">Body Shape</label>
              <select id="bodyShape1">
                <option>Hourglass</option><option>Apple</option><option>Pear (Triangle)</option>
                <option>Rectangle (Straight)</option><option>Inverted Triangle</option>
              </select>
              <label for="occasion1">Occasion</label>
              <select id="occasion1">
                <option>Casual</option><option>Formal</option><option>Performance</option><option>Editorial</option>
              </select>
              <label for="color1">Color</label>
              <div class="color-selection-wrapper">
                <label class="color-picker-label" id="color-preview1" style="background-color: #000000;">
                    <input type="color" id="color1" value="#000000">
                </label>
              </div>
              <div id="palette-container1" class="palette-container">
                  <button id="ok-color1" class="palette-generate-button" data-original-text="Generate Palettes" data-processing-text="Generating...">Generate Palettes</button>
              </div>
            </div>
          </div>
          <div class="canvas">
            <div id="feature1-output" class="feature output-feature">
              <div class="button-group">
                  <button id="generate1" data-original-text="Generate" data-processing-text="Generating...">Generate</button>
                  <button id="expand1" data-original-text="Expand" data-processing-text="Expanding..." disabled>Expand</button>
                  <button id="mutate1" data-original-text="Mutate" data-processing-text="Mutating..." disabled>Mutate</button>
                  <button id="copy1">Copy</button>
                  <button id="export1">Export</button>
                  <button id="clear1">Clear</button>
              </div>
              <div id="output1" class="output"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-content-2" class="tab-content">
        <div class="feature-container">
          <div class="control-panel">
            <div id="feature2-inputs" class="feature">
              <h2>Fashion Concept</h2>
               <label for="style2">Style</label>
              <select id="style2">
                <option>Minimalist</option><option>Casual</option><option>Sporty</option><option>Gothic</option>
                <option>Classic</option><option>Punk</option><option>Futuristic</option><option>Y2K</option>
                <option>Formal</option><option>Vintage</option><option>Streetwear</option><option>Bohemia</option>
              </select>
              <label>Garment Type</label>
              <div class="checkbox-container">
                <div class="checkbox-group" id="garmentType2">
                  <label><input type="checkbox" value="Blazer">Blazer</label><label><input type="checkbox" value="Dress">Dress</label>
                  <label><input type="checkbox" value="Skirt">Skirt</label><label><input type="checkbox" value="Trousers">Trousers</label>
                  <label><input type="checkbox" value="Jumpsuit">Jumpsuit</label><label><input type="checkbox" value="Hoodie">Hoodie</label>
                  <label><input type="checkbox" value="Coat">Coat</label><label><input type="checkbox" value="Shirt">Shirt</label>
                  <label><input type="checkbox" value="T-Shirt">T-Shirt</label><label><input type="checkbox" value="Gown">Gown</label>
                  <label><input type="checkbox" value="Set">Set</label><label><input type="checkbox" value="Shoes">Shoes</label>
                </div>
              </div>
              <label for="color2">Color</label>
              <div class="color-selection-wrapper">
                <label class="color-picker-label" id="color-preview2" style="background-color: #000000;">
                    <input type="color" id="color2" value="#000000">
                </label>
              </div>
              <div id="palette-container2" class="palette-container">
                  <button id="ok-color2" class="palette-generate-button" data-original-text="Generate Palettes" data-processing-text="Generating...">Generate Palettes</button>
              </div>
              <label for="climate2">Climate</label>
              <select id="climate2">
                <option>Hot / Humid</option><option>Mild</option><option>Cool / Cold</option>
                <option>Rain</option><option>Don’t mind, as long as the fit is cool</option>
              </select>
            </div>
          </div>
          <div class="canvas">
            <div id="feature2-output" class="feature output-feature">
              <div class="button-group">
                  <button id="generate2" data-original-text="Generate" data-processing-text="Generating...">Generate</button>
                  <button id="expand2" data-original-text="Expand" data-processing-text="Expanding..." disabled>Expand</button>
                  <button id="mutate2" data-original-text="Mutate" data-processing-text="Mutating..." disabled>Mutate</button>
                  <button id="copy2">Copy</button>
                  <button id="export2">Export</button>
                  <button id="clear2">Clear</button>
              </div>
              <div id="output2" class="output"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const featureStates = { '0': {}, '1': { lastConcept: '', selectedPalette: '' }, '2': { lastConcept: '', selectedPalette: '' } };
      
      const okColorBtn1 = document.getElementById('ok-color1');
      const okColorBtn2 = document.getElementById('ok-color2');

      function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

      function toggleInputs(featureId, isDisabled) {
        const inputsContainer = document.getElementById(`feature${featureId}-inputs`);
        if (!inputsContainer) return;
        const elements = inputsContainer.querySelectorAll('select, input[type="checkbox"], input[type="color"], .palette-generate-button');
        elements.forEach(el => { el.disabled = isDisabled; });
      }

      async function callProxy(prompt, outputEl, btnEl, featureId) {
        const originalText = btnEl ? btnEl.dataset.originalText : '';
        const processingText = btnEl ? (btnEl.dataset.processingText || 'Generating...') : 'Generating...';
        
        if (outputEl) outputEl.innerHTML = processingText;
        if (btnEl) { btnEl.disabled = true; btnEl.textContent = processingText; }
        if (featureId) toggleInputs(featureId, true);
        
        try {
            const response = await fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(prompt) });
            const data = await response.json();
            if (!response.ok) { throw new Error(data.error || `API error with status ${response.status}`); }
            
            const text = data.text || 'No content generated.';
            if (outputEl) {
                const cleanHtml = text.replace(/\*\*/g, '').replace(/(\r\n|\n|\r)/gm, '<br>');
                outputEl.innerHTML = cleanHtml;
            }
            return text;
        } catch (e) {
            if (outputEl) outputEl.textContent = `Error: ${e.message}`;
            console.error("API call failed:", e);
            return null;
        } finally {
            if (btnEl) {
                btnEl.disabled = false;
                btnEl.textContent = originalText;
            }
            if (featureId) toggleInputs(featureId, false);
        }
      }

      async function generatePalettes(hexColor, containerEl, okBtn) {
          const prompt = {
            text: `Given main hex color "${hexColor}", generate three distinct creative color palettes. Each palette needs a unique theme name. For each, provide a list of exactly 3 complementary colors with a "name" and a valid "hex" code. Respond ONLY with a valid JSON object like this: {"palettes": [{"theme": "Theme Name", "colors": [{"name": "Color Name", "hex": "#_hex_code"}]}]}`
          };
          
          containerEl.innerHTML = '<h4>Generating palettes...</h4>';
          const featureId = containerEl.id.replace('palette-container', '');
          const resultText = await callProxy(prompt, null, okBtn, featureId);
          
          if(!resultText){
              containerEl.innerHTML = `<h4>Error generating palettes. Please try again.</h4>`;
          } else {
              try {
                  const jsonStringMatch = resultText.match(/\{.*\}/s);
                  if (!jsonStringMatch) throw new Error("Invalid JSON from AI.");
                  
                  const palettesData = JSON.parse(jsonStringMatch[0]);
                  containerEl.innerHTML = '<h4>Click a palette to use it:</h4>';
                  palettesData.palettes.forEach(p => {
                      const paletteDiv = document.createElement('div');
                      paletteDiv.className = 'palette';
                      paletteDiv.title = `Use the ${p.theme} palette`;
                      paletteDiv.innerHTML = `<h4>${p.theme}:</h4><div class="swatches">${p.colors.map(c => `<div class="swatch" title="${c.name}" style="background-color:${c.hex};"></div>`).join('')}</div><span class="checkmark">✔</span>`;
                      paletteDiv.onclick = () => {
                          featureStates[featureId].selectedPalette = `${p.theme} palette of ${p.colors.map(c=>c.name).join(', ')}`;
                          document.querySelectorAll(`#palette-container${featureId} .palette`).forEach(el => el.classList.remove('selected'));
                          paletteDiv.classList.add('selected');
                      };
                      containerEl.appendChild(paletteDiv);
                  });
              } catch (e) {
                  containerEl.innerHTML = `<h4>Error parsing palettes. Please try again.</h4>`; console.error(e);
              }
          }
          const originalBtn = featureId === '1' ? okColorBtn1 : okColorBtn2;
          containerEl.prepend(originalBtn);
      }

      function clearFeature(id) {
        featureStates[id] = { lastConcept: '', selectedPalette: '' };
        document.getElementById(`output${id}`).innerHTML = '';
        const paletteContainer = document.getElementById(`palette-container${id}`);
        if (paletteContainer) {
            paletteContainer.innerHTML = '';
            const originalBtn = id === '1' ? okColorBtn1 : okColorBtn2;
            paletteContainer.appendChild(originalBtn);
        }
        document.querySelectorAll(`#garmentType${id} input[type="checkbox"]`).forEach(cb => cb.checked = false);
        document.querySelectorAll(`#feature${id}-inputs select`).forEach(s => s.selectedIndex = 0);
        document.getElementById(`expand${id}`).disabled = true;
        document.getElementById(`mutate${id}`).disabled = true;
      }
      
      const tabs = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          tabContents.forEach(c => c.classList.remove('active'));
          document.getElementById(`tab-content-${tab.dataset.tab}`).classList.add('active');
        });
      });

      const videoEl = document.getElementById('camera-feed');
      const canvasEl = document.getElementById('capture-canvas');
      const startBtn = document.getElementById('start-camera');
      const stopBtn = document.getElementById('stop-camera');
      const uploadBtn = document.getElementById('upload-image');
      const imageUploader = document.getElementById('image-uploader');
      const captureBtn = document.getElementById('capture-image');
      const output0 = document.getElementById('output0');
      const timerControls = document.getElementById('timer-controls');
      const countdownOverlay = document.getElementById('countdown-overlay');
      const initialOutputContent = "Enable your camera or upload a picture to get styling ideas.";
      let stream = null;

      function stopStream() {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
      }

      function resetCameraToInitialState() {
          stopStream();
          videoEl.srcObject = null;
          videoEl.style.display = 'block';
          canvasEl.style.display = 'none';
          output0.innerHTML = initialOutputContent;
          startBtn.textContent = "Start Camera";
          startBtn.disabled = false;
          stopBtn.style.display = 'none';
          uploadBtn.style.display = 'inline-block';
          uploadBtn.disabled = false;
          captureBtn.disabled = true;
          timerControls.style.display = 'none';
          countdownOverlay.style.display = 'none';
      }

      async function startOrResetCamera() {
          if (startBtn.textContent === "Start Over") {
            videoEl.style.display = 'block';
            canvasEl.style.display = 'none';
            output0.innerHTML = initialOutputContent;
            uploadBtn.style.display = 'inline-block';
          }
          if (stream) stopStream();
          try {
              stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
              videoEl.srcObject = stream;
              await videoEl.play();
              startBtn.textContent = "Start Over";
              stopBtn.style.display = 'inline-block';
              stopBtn.disabled = false;
              uploadBtn.style.display = 'none';
              captureBtn.disabled = false;
              timerControls.style.display = 'flex';
          } catch (err) {
              output0.textContent = `Error accessing camera: ${err.message}`;
              resetCameraToInitialState();
          }
      }

      startBtn.addEventListener('click', startOrResetCamera);
      stopBtn.addEventListener('click', resetCameraToInitialState);
      uploadBtn.addEventListener('click', () => imageUploader.click());

      imageUploader.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            stopStream();
            const img = new Image();
            img.onload = () => {
                canvasEl.style.transform = 'none';
                const context = canvasEl.getContext('2d');
                canvasEl.width = img.width;
                canvasEl.height = img.height;
                context.drawImage(img, 0, 0);
                videoEl.style.display = 'none';
                canvasEl.style.display = 'block';
                startBtn.textContent = "Start Over";
                stopBtn.style.display = 'none';
                uploadBtn.style.display = 'inline-block';
                captureBtn.disabled = false;
                timerControls.style.display = 'none';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        event.target.value = null;
      });

      captureBtn.addEventListener('click', () => {
        const isFromLiveCamera = videoEl.style.display !== 'none';
        const timerValue = isFromLiveCamera ? parseInt(document.querySelector('input[name="timer"]:checked').value, 10) : 0;
        
        const performAnalysis = async () => {
            let base64ImageData;

            if (isFromLiveCamera) {
                canvasEl.style.transform = 'scaleX(-1)';
                const context = canvasEl.getContext('2d');
                canvasEl.width = videoEl.videoWidth;
                canvasEl.height = videoEl.videoHeight;
                context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
                videoEl.style.display = 'none';
                canvasEl.style.display = 'block';
                stopStream();
                stopBtn.style.display = 'none';
            }
            
            base64ImageData = canvasEl.toDataURL('image/jpeg', 0.5).split(',')[1];
            
            const stylePrompt = {
              text: `Analyze the user's outfit in the image. Follow this example format exactly.
EXAMPLE:
"This look has a relaxed, academic vibe! The layers are well-chosen for a smart-casual feel.

Here are a couple of ideas to elevate it:
1. **Define the Waist:** Try tucking in the striped polo shirt to create a clearer waistline. This will add structure and contrast nicely with the looser jacket.
2. **Elevate the Footwear:** Swap the current shoes for a pair of chunky leather loafers. This will keep the comfort but add a more polished, intentional feel to the whole outfit."

NOW, analyze the provided image and give a similar response: a one-sentence vibe summary, followed by exactly two numbered, actionable, and encouraging styling tips.`,
              image: base64ImageData
            };
            
            [startBtn, stopBtn, uploadBtn, captureBtn].forEach(btn => btn.disabled = true);

            await callProxy(stylePrompt, output0, captureBtn, '0');

            startBtn.disabled = false;
            uploadBtn.disabled = false;
        };
        
        if (timerValue > 0) {
            let count = timerValue;
            countdownOverlay.textContent = count;
            countdownOverlay.style.display = 'flex';
            const interval = setInterval(() => {
                count--;
                countdownOverlay.textContent = count;
                if (count <= 0) {
                    clearInterval(interval);
                    countdownOverlay.style.display = 'none';
                    performAnalysis();
                }
            }, 1000);
        } else {
            performAnalysis();
        }
      });

      ['1', '2'].forEach(id => {
        document.getElementById(`generate${id}`).addEventListener('click', async (ev) => {
            const style = document.getElementById(`style${id}`).value;
            const garmentTypes = Array.from(document.querySelectorAll(`#garmentType${id} input:checked`)).map(el => el.value).join(', ');
            const color = document.getElementById(`color${id}`).value;
            const paletteInfo = featureStates[id].selectedPalette ? `using the selected ${featureStates[id].selectedPalette}` : '';
            let text;

            if (id === '1') {
                const bodyShape = document.getElementById('bodyShape1').value;
                const occasion = document.getElementById('occasion1').value;
                text = `You are a fashion stylist. Create a direct outfit recommendation based on user inputs. Follow this format:
1. **The Vibe:** [A short, mood-based summary]
2. **Style Formula:**
- Top: [Item description]
- Bottom: [Item description]
- Shoes: [Item description]
- Accessories: [Item description]
3. **Pro Tip:** [One actionable tip related to body shape or color theory]

Here are the user inputs: Style: ${style}, Garment(s): ${garmentTypes || 'Any'}, Body Shape: ${bodyShape}, Occasion: ${occasion}, Main Color: ${color} ${paletteInfo}.`;
            } else {
                const climate = document.getElementById('climate2').value;
                text = `As an innovative fashion strategist, give a concise and actionable Fashion Concept (~150 words). Inputs: Style: ${style}, Garment(s): ${garmentTypes || 'Any'}, Main Color: ${color} ${paletteInfo}, Climate: ${climate}.`;
            }
            
            const result = await callProxy({ text }, document.getElementById(`output${id}`), ev.currentTarget, id);
            if (result) {
                featureStates[id].lastConcept = result;
                document.getElementById(`expand${id}`).disabled = false;
                document.getElementById(`mutate${id}`).disabled = false;
            }
        });

        document.getElementById(`expand${id}`).addEventListener('click', (ev) => {
            const text = `Take this fashion idea and expand on it. Provide more detail on materials, construction, and alternative styling options. Make it about 300 words. Here is the original idea: "${featureStates[id].lastConcept}"`;
            callProxy({ text }, document.getElementById(`output${id}`), ev.currentTarget, id);
        });

        document.getElementById(`mutate${id}`).addEventListener('click', async (ev) => {
            const text = `Take this fashion idea and create a new, different version of it. Change the style or core concept. Keep it concise. Here is the original idea: "${featureStates[id].lastConcept}"`;
            const result = await callProxy({ text }, document.getElementById(`output${id}`), ev.currentTarget, id);
            if (result) { 
              featureStates[id].lastConcept = result;
              document.getElementById(`expand${id}`).disabled = false;
              document.getElementById(`mutate${id}`).disabled = false;
            }
        });
        
        document.getElementById(`copy${id}`).addEventListener('click', () => navigator.clipboard.writeText(document.getElementById(`output${id}`).textContent).then(() => alert('Copied!')));
        document.getElementById(`export${id}`).addEventListener('click', () => {
          const blob = new Blob([document.getElementById(`output${id}`).textContent], { type: 'text/plain' });
          const a = document.createElement('a');
          a.download = id === '1' ? 'daily_outfit.txt' : 'fashion_concept.txt';
          a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
        });
        document.getElementById(`clear${id}`).addEventListener('click', () => clearFeature(id));
        
        const colorInput = document.getElementById(`color${id}`);
        const paletteContainer = document.getElementById(`palette-container${id}`);
        const okColorBtn = document.getElementById(`ok-color${id}`);
        document.getElementById(`color-preview${id}`).parentElement.addEventListener('click', () => colorInput.click());
        colorInput.addEventListener('input', () => { document.getElementById(`color-preview${id}`).style.backgroundColor = colorInput.value; });
        okColorBtn.addEventListener('click', () => { 
            generatePalettes(colorInput.value, paletteContainer, okColorBtn);
        });
      });
      
      const docEl = document.documentElement;
      const accentPicker = document.getElementById('accent-color-picker');
      const accentPreview = document.getElementById('accent-color-preview');
      function setTheme(t){ docEl.setAttribute('data-theme', t); localStorage.setItem('whatthefit_theme', t); }
      function setAccentColor(c){
        docEl.style.setProperty('--primary-accent-color', c);
        const hoverColor = c.length === 7 ? c + 'BF' : c; 
        docEl.style.setProperty('--primary-accent-hover', hoverColor);
        docEl.style.setProperty('--checkmark-color', c);
        accentPreview.style.backgroundColor = c;
        localStorage.setItem('whatthefit_accent', c);
      }
      document.getElementById('light-mode-btn').addEventListener('click', ()=>setTheme('light'));
      document.getElementById('dark-mode-btn').addEventListener('click', ()=>setTheme('dark'));
      accentPicker.addEventListener('input', (e)=>setAccentColor(e.target.value));

      const savedTheme = localStorage.getItem('whatthefit_theme') || 'light';
      const savedAccent = localStorage.getItem('whatthefit_accent') || '#000000';
      setTheme(savedTheme); 
      setAccentColor(savedAccent); 
      accentPicker.value = savedAccent;

      const syncAllHeights = () => {
        if (window.innerWidth <= 900) {
          ['0', '1', '2'].forEach(id => {
            const output = document.getElementById(`feature${id}-output`);
            if (output) output.style.height = 'auto';
          });
          return;
        }
        ['0', '1', '2'].forEach(id => {
            const inputs = document.getElementById(`feature${id}-inputs`);
            const output = document.getElementById(`feature${id}-output`);
            if (inputs && output) {
              output.style.height = `${inputs.offsetHeight}px`;
            }
        });
      };
      
      ['0', '1', '2'].forEach(id => {
        const inputPanel = document.getElementById(`feature${id}-inputs`);
        if (inputPanel) { new ResizeObserver(syncAllHeights).observe(inputPanel); }
      });
      window.addEventListener('load', syncAllHeights);
      window.addEventListener('resize', syncAllHeights);
    </script>
  </body>
</html>
